# iOS Shortcut 半自動化方案

## 📋 背景

**問題**：Cloud Run 無頭模式在松菸網站 100% 觸發 reCAPTCHA 圖片驗證，Vision API 方案複雜且不穩定。

**新方案**：改用 iOS Shortcut + 人工輔助，善用媽媽的 VoiceOver 操作能力。

---

## 🎯 方案概述

**使用者**：媽媽透過 VoiceOver 操作

### 自動化部分（Shortcut）
1. 從 Google Drive 下載申請 PDF 和街頭藝人證到 iCloud「下載項目」
2. 自動開啟松菸網站第一頁
3. 自動點擊「我要申請」進入第二頁
4. 自動預填個人資料（硬編碼在 JavaScript 中）
5. 自動勾選「同意條款」

### 人工操作部分（媽媽用 VoiceOver）
1. 上傳申請 PDF（下載項目第一個檔案）
2. 上傳街頭藝人證（下載項目第二個檔案）
3. 勾選「我不是機器人」
4. 點擊「確認送出」

**預估操作時間**：2-3 分鐘

---

## 🏗️ 技術架構

```
LINE 申請 
  ↓
GAS 處理 + Cloud Run 生成 PDF
  ↓
LINE 發送 Shortcut 啟動連結
  ↓
媽媽點擊按鈕 → iOS Shortcut 執行
  ↓
自動下載檔案 + 開啟網站 + 預填表單
  ↓
媽媽接手完成上傳和提交
```

---

## 📱 iOS Shortcut 流程

### Shortcut 名稱
`松菸申請`

### 輸入資料（從 LINE 傳入）

**只需傳遞兩個檔案 URL**：
- `pdf_url`：申請 PDF 的直接下載連結
- `cert_url`：街頭藝人證的直接下載連結

**個資處理原則**：
- ✅ 個人資料（姓名、電話、Email）**硬編碼在 Shortcut 的 JavaScript 中**
- ✅ GAS 不需要傳遞個資
- ✅ LINE 訊息 URL 中不含個資
- ✅ 隱私保護最大化：個資只出現在 Shortcut 內部

### 執行步驟

按照以下順序建立 Shortcut 動作：

---

#### 第一段：下載申請 PDF

1. 新增動作：**取得捷徑輸入**
2. 新增動作：**從字典取得值**
   - 鍵值：`pdf_url`
3. 新增動作：**取得 URL 的內容**
   - 輸入：選擇上一步的結果
4. 新增動作：**儲存檔案**
   - 位置：iCloud Drive/Downloads
   - 詢問儲存位置：關閉
   - 覆寫已存在檔案：開啟
5. 新增動作：**朗讀文字**
   - 文字：`申請表儲存完成`

---

#### 第二段：下載街頭藝人證

1. 新增動作：**取得捷徑輸入**
2. 新增動作：**從字典取得值**
   - 鍵值：`cert_url`
3. 新增動作：**取得 URL 的內容**
   - 輸入：選擇上一步的結果
4. 新增動作：**儲存檔案**
   - 位置：iCloud Drive/Downloads
   - 詢問儲存位置：關閉
   - 覆寫已存在檔案：開啟
5. 新增動作：**朗讀文字**
   - 文字：`藝人證儲存完成`

---

#### 第三段：開啟松菸網站

1. 新增動作：**開啟 URL**
   - URL：`https://www.songshanculturalpark.org/solicitation`
2. 新增動作：**等待**
   - 時間：2 秒
3. 新增動作：**朗讀文字**
   - 文字：`已開啟網站`

---

#### 第四段：點擊申請按鈕

1. 新增動作：**等待**
   - 時間：2 秒
2. 新增動作：**在網頁上執行 JavaScript**
   - JavaScript：自動尋找並點擊「我要申請」按鈕
   - 功能：查詢包含「我要申請」和「街頭藝人」的連結並點擊

---

#### 第五段：預填表單並勾選同意

1. 新增動作：**等待**
   - 時間：4 秒
2. 新增動作：**在網頁上執行 JavaScript**
   - JavaScript：填寫表單欄位並勾選同意條款
   - 功能：
     - 填寫姓名、手機、Email（硬編碼值）
     - 勾選同意條款 checkbox
3. 新增動作：**朗讀文字**
   - 文字：`基本資料填好了`

---

#### 第六段：人工操作語音指引

1. 新增動作：**朗讀文字**
   - 文字：`現在交給老媽接手`

---

## 🔧 技術實作要點

### 1. Google Drive 下載機制

**直接下載 URL 格式**：
```
https://drive.google.com/uc?export=download&id=FILE_ID
```

**檔案權限設定**：
- GAS 使用 `Drive.Permissions.insert()` 設定為公開
- 類型：`anyone`（任何人）
- 角色：`reader`（唯讀）

**優點**：
- 不需要 Google Drive App
- Shortcut 背景下載，不開啟瀏覽器
- 直接儲存到 iCloud Drive

### 2. JavaScript 自動化

**腳本 1：點擊「我要申請」**
- 查詢所有 `<a>` 連結
- 找到同時包含「我要申請」和「街頭藝人」的按鈕
- 執行點擊

**腳本 2：預填表單並勾選同意**
- 使用 `input[placeholder*="姓名"]` 等選擇器
- 填入硬編碼的個人資料
- 勾選 `input#signup` 同意條款 checkbox

**錯誤處理**：
- 如果找不到元素，回傳錯誤訊息
- Shortcut 會朗讀錯誤
- 媽媽可以手動操作

### 3. GAS 整合

**新增函數**：`sendShortcutLinkToLine()`

**功能**：
1. 設定 PDF 和證照檔案為公開權限
2. 產生直接下載連結
3. 組合 Shortcut URL（只包含兩個檔案 URL）
4. 透過 LINE Push Message 發送快速回覆按鈕

**呼叫時機**：
- Cloud Run 處理完成後
- PDF 生成成功時
- 在現有流程中加入這個步驟

**LINE 訊息格式**：
- 文字：申請資訊（月份、日期）
- Quick Reply：「🚀 上網填表」按鈕
- URI：`shortcuts://run-shortcut?name=松菸申請&input={...}`

---

## 🔑 關鍵設計決策

### 決策 1：個資硬編碼在 JavaScript

**理由**：
- 使用者永遠是同一人
- 隱私保護：LINE 訊息不含個資
- 簡化 Shortcut 流程（減少 3-4 步驟）
- GAS 不需要處理個資

**實作方式**：
- 在 JavaScript 中直接寫入固定值
- 實際撰寫時從安全位置取得資料

### 決策 2：等待時間設定

**第一頁載入**：2 秒
**第二頁載入**：4 秒

**理由**：
- 足夠 99% 情況使用
- 如果失敗，語音提示錯誤
- 媽媽可以手動完成

### 決策 3：VoiceOver 相容性優先

**所有語音提示**：
- 使用「朗讀文字」動作
- 簡潔明確（如「申請表儲存完成」而非「正在儲存...」）
- 重要節點才提示（下載完成、網站開啟、資料填好）
- 與 VoiceOver 不衝突

**檔案順序**：
- 確保 PDF 先下載（第一個）
- 證照後下載（第二個）
- 符合「下載項目」順序，方便媽媽上傳

---

## 📝 實作步驟（漸進式開發）

### 階段 0：準備測試環境（5 分鐘）

**目的**：驗證 Google Drive 直接下載機制

**步驟**：
1. 手動上傳測試 PDF 到 Google Drive
2. 設定為「知道連結的任何人」
3. 組合直接下載連結
4. 在 iPhone Safari 測試是否能下載

**驗收標準**：
- [ ] Safari 直接下載檔案
- [ ] 不需要 Google Drive App

---

### 階段 1：簡單 Shortcut 測試下載（15 分鐘）

**目的**：驗證 Shortcut 下載功能

**建立簡化測試版**：
- 只實作「第一段：下載申請 PDF」
- 暫時用固定 URL 測試（不需要輸入參數）

**測試方式**：
- 直接執行 Shortcut
- 確認檔案出現在 iCloud Drive/Downloads

**驗收標準**：
- [ ] Shortcut 執行成功
- [ ] 檔案成功下載到指定位置
- [ ] 聽到語音提示「申請表儲存完成」

---

### 階段 2：雙檔案下載（10 分鐘）

**目的**：確保兩個檔案下載和順序正確

**擴充 Shortcut**：
- 實作「第一段：下載申請 PDF」
- 實作「第二段：下載街頭藝人證」
- 開始使用捷徑輸入參數（傳入兩個 URL）

**驗收標準**：
- [ ] 兩個檔案都成功下載
- [ ] 在「檔案」App 中，PDF 在證照之前
- [ ] 聽到兩次語音提示（申請表、藝人證）

---

### 階段 3：GAS 發送連結（20 分鐘）

**目的**：確保 LINE 訊息和連結格式正確

**實作重點**：
1. 加入 `setFilePublicPermission()` 函數
2. 加入測試函數 `testSendShortcutLink()`
3. 在 GAS 執行測試

**驗收標準**：
- [ ] LINE 收到按鈕
- [ ] 點擊後啟動 Shortcut
- [ ] 檔案成功下載

---

### 階段 4：網站導航（20 分鐘）

**目的**：測試開啟網站和點擊申請按鈕

**擴充 Shortcut**：
- 實作「第三段：開啟松菸網站」
- 實作「第四段：點擊申請按鈕」
- 撰寫第一個 JavaScript：自動點擊「我要申請」

**驗收標準**：
- [ ] Safari 自動開啟松菸網站
- [ ] 聽到「已開啟網站」
- [ ] 自動點擊進入表單頁

---

### 階段 5：完整 Shortcut（20 分鐘）

**目的**：完成所有自動化功能

**擴充 Shortcut**：
- 實作「第五段：預填表單並勾選同意」
- 實作「第六段：人工操作語音指引」
- 撰寫第二個 JavaScript：預填表單 + 勾選同意

**驗收標準**：
- [ ] 檔案下載成功
- [ ] 網站自動導航
- [ ] 表單自動預填（姓名、手機、Email）
- [ ] 同意條款自動勾選
- [ ] 聽到「基本資料填好了」
- [ ] 聽到「現在交給老媽接手」

---

### 階段 6：GAS 整合真實流程（30 分鐘）

**目的**：連接完整申請流程

**實作重點**：
- 加入正式 `sendShortcutLinkToLine()` 函數
- 在 Cloud Run 回調成功後呼叫
- 使用真實的 PDF 和證照檔案
- 確認 Shortcut 名稱為「松菸申請」

**驗收標準**：
- [ ] LINE 申請後收到「🚀 上網填表」按鈕
- [ ] 按鈕包含真實的 PDF 和證照 URL
- [ ] 點擊後啟動「松菸申請」Shortcut
- [ ] 完整流程順利執行

---

### 階段 7：端到端測試（30 分鐘）

**目的**：完整流程驗證

**測試流程**：
1. 在 LINE 發起真實申請
2. 選擇日期和影片
3. 等待 Cloud Run 處理
4. 收到 Shortcut 按鈕
5. 點擊執行 Shortcut
6. 確認所有自動化步驟
7. 手動完成上傳和提交
8. 確認申請成功

**驗收標準**：
- [ ] 完整流程順暢
- [ ] 操作時間 < 5 分鐘
- [ ] 申請成功提交

---

### 階段 8：交付使用（1 小時）

**目的**：實際交付使用並優化

**8.1 分享 Shortcut**：
1. 長按 Shortcut → 分享
2. 複製 iCloud 連結
3. 傳給媽媽匯入

**8.2 教學和陪同**：
1. 說明完整流程
2. 陪同完成第一次申請
3. 記錄遇到的問題
4. 調整語音提示或流程

**8.3 收集反饋**：
- VoiceOver 體驗如何？
- 語音提示是否清楚？
- 操作時間是否可接受？
- 哪些步驟需要優化？

**驗收標準**：
- [ ] 媽媽能獨立完成申請
- [ ] 操作時間 < 5 分鐘
- [ ] 成功率 > 90%

---

## ⚠️ 注意事項

### 檔案順序
- 確保 PDF 第一個下載（最新）
- 證照第二個下載（次新）
- 媽媽上傳時按照「下載項目」順序

### JavaScript 失敗處理
- 如果等待時間不夠，會朗讀錯誤
- 媽媽可以手動填寫表單
- 不影響整體流程

### 網站改版
- 如果松菸網站改版，選擇器可能失效
- 需要更新 JavaScript 腳本中的選擇器
- 短期內可以完全人工操作

### Shortcut 維護
- JavaScript 腳本在 Shortcut 中修改
- 選擇器失效時更新
- 語音提示文字可隨時調整

---

## 📊 優缺點評估

### 優點
- ✅ 完全繞過 reCAPTCHA 圖片驗證問題
- ✅ 善用媽媽的 VoiceOver 操作能力
- ✅ 大部分流程自動化（下載、導航、預填）
- ✅ 媽媽只需操作 2-3 分鐘
- ✅ 不需要複雜的 Vision API
- ✅ LINE 訊息不含個資，隱私保護佳

### 缺點
- ⚠️ 需要媽媽手動操作（但可接受）
- ⚠️ 需要建立和維護 Shortcut
- ⚠️ 網站改版需要更新腳本
- ⚠️ 只支援 iOS 平台

---

## 🎯 成功標準

1. **可用性**：媽媽能獨立完成申請（成功率 > 90%）
2. **效率性**：操作時間 < 5 分鐘
3. **無障礙性**：VoiceOver 體驗流暢
4. **易理解性**：語音提示清楚明確

---

## 📝 文件資訊

**建立日期**：2025年11月12日  
**最後更新**：2025年11月15日  
**文件定位**：最上位開發指引  
**當前狀態**：規劃階段，待實作

**技術細節**：
- 具體程式碼實作請參考各模組的程式檔案
- 此文件聚焦於策略、流程、決策說明
- 開發時以實際程式碼為準

---
