# 街頭藝人表演場地申請自動化系統 PRD

## 🎯 開發原則

### 核心開發理念
1. **最小化開發**：優先開發核心功能，不要過度設計
2. **階段性驗證**：每階段都有測試點，確保功能正確後再進入下個階段

## 📋 專案概述

### 目標
為視障使用者開發一個自動化系統，透過LINE Bot簡化每月申請街頭藝人表演場地的流程，自動處理申請表PDF生成和街頭藝人證照上傳，減少人工操作，提高申請效率。

### 使用者
- **主要使用者**：視障使用者（完全看不到，使用Apple手機語音輸入）
- **協助使用者**：家人（系統測試、代為申請、緊急處理）
- **權限設計**：群組內任何成員都可觸發申請，但會記錄操作者身份

### 核心價值
- 每月15日前自動完成街頭藝人場地申請
- 透過熟悉的LINE介面降低學習成本
- 全自動化處理，減少人工介入

## 🎯 功能需求

### 1.1 LINE Bot互動系統

#### 核心能力
- **指令解析**：支援自然語言指令，透過OpenAI API處理語音轉文字錯誤
- **智能確認**：基於AI語意解析和信心度評分的確認機制
- **時間窗口管理**：根據當前日期自動判斷申請月份，時間窗口控制
- **日期管理**：自動計算週六日期，預設提供每月前3個週六，支援用戶自訂選擇（含週日）
- **檔案處理**：支援常用影片和新影片上傳，自動存儲到Google Drive
- **狀態追蹤**：即時回報處理進度和結果

#### 支援指令
```
申請指令：「申請」（自動判斷月份）
```

#### 申請時間窗口控制
- **申請開放期**：每月1-15日可申請下個月份
- **申請關閉期**：每月16-31日不可申請，提示下個月1-15日開放申請
- **月份推算規則**：
  - 申請期內（1-15日）：申請月份 = 當前月份 + 1
  - 申請關閉期（16-31日）：提示申請月份 = 當前月份 + 2，開放時間 = 下個月1-15日
  - 例如：
    - 8月1-15日：可申請9月份
    - 8月16-31日：不可申請，提示「9月1-15日可申請10月份」
    - 9月1-15日：可申請10月份

#### 群組架構
- **三人群組模式**：主要用戶 + 協助者 + Bot
- **透明互動**：所有對話記錄群組成員皆可查看

### 1.2 後端自動化系統

#### 資料處理能力
- **時間窗口檢查**：判斷當前日期是否在申請期間（1-15日規則）
- **月份推算**：根據當前日期計算申請月份（當前月+1或+2）
- **日期計算**：自動計算指定月份的週六和週日日期
- **檔案管理**：Google Drive檔案上傳下載（影片、PDF），讀取固定證照檔案，權限設定
- **資料記錄**：Google Sheets讀寫和狀態管理，支援靈活日期格式記錄

#### 文件處理能力
- **模板處理**：Word文件自動填寫和格式化
- **格式轉換**：Word轉PDF，支援自訂檔名規則
- **內容整合**：申請資訊、影片連結、個人資料整合
- **證照讀取**：從Google Drive指定位置讀取固定的街頭藝人證照圖檔

#### 網站自動化能力
- **瀏覽器控制**：Playwright自動化網頁操作
- **表單填寫**：智能識別表單欄位並填入資料
- **檔案上傳**：自動上傳申請PDF和街頭藝人證照圖檔到指定網站
- **提交確認**：驗證提交結果並記錄狀態

### 1.3 可靠性保障機制

#### 容錯處理
- **自動重試機制**：網站操作失敗時自動重試3次，每次間隔30秒
- **錯誤記錄**：在Google Sheets的「錯誤訊息」欄位記錄具體錯誤描述和重試資訊
- **狀態管理**：處理開始時記錄開始時間並更新狀態為「處理中」，成功時記錄完成時間並更新為「完成」，失敗時更新狀態為「失敗」（完成時間保持空白）

#### 通知機制
- **失敗通知**：重試失敗後立即通知LINE群組，包含申請資訊和錯誤原因
- **人工處理流程**：家人收到通知後下載已生成的PDF檔案，手動提交到表演場地網站
- **無需回報**：人工處理完成後無需通知系統，該筆記錄保持「失敗」狀態

## 🏗️ 技術架構

### 2.1 系統架構圖
```
LINE群組 ↔ Google Apps Script (LINE Bot + OpenAI整合) ↔ Google Sheets ↔ Google Cloud Run (Python) ↔ 表演場地網站
                     ↓                                        ↓
              OpenAI API (語意解析)                    Google Drive + 網站自動化 + 文件處理
```

### 2.2 技術選型

#### 前端互動層
- **LINE Messaging API**：處理群組訊息
- **Google Apps Script**：LINE Bot邏輯處理和OpenAI API整合
- **OpenAI API**：智能語音語意解析（GPT-4o-mini）
- **純文字指令**：避免複雜UI，適合視障用戶

#### 後端處理層
- **Google Cloud Run**：Python服務運行環境
- **Playwright**：網站自動化工具
- **python-docx**：Word文件處理
- **LibreOffice headless**：PDF轉換（使用soffice命令行工具）

#### 資料存儲層
- **Google Drive**：影片、文件模板存儲，固定證照檔案存放
- **Google Sheets**：申請記錄和狀態管理
- **檔案權限**：「有連結者可檢視」

### 2.3 API整合
- **Google Drive API v3**：檔案存取和管理
- **Google Sheets API v4**：申請記錄和狀態管理
- **LINE Messaging API**：群組訊息處理
  - `get_profile` API：取得用戶顯示名稱
- **OpenAI API**：語音語意解析和智能回應
  - 模型：GPT-4o-mini
  - 用途：處理語音輸入錯誤、意圖識別、日期選擇解析

### 2.4 Google Drive檔案結構

#### 完整資料夾架構
```
/街頭藝人登記/
├── 證照文件/
│   └── 街頭藝人證.jpg                    (固定檔案)
├── 表演影片/
│   ├── 表演影片.mp4                      (常用影片，固定檔案)
│   └── 上傳影片/                         (新上傳影片存放處)
│       ├── 表演影片_2025年10月_1009_1751.mp4
│       ├── 表演影片_2025年10月_1009_2311.mp4
│       └── ...
├── 申請文件/
│   ├── 模板/
│   │   ├── 申請表模板.docx               (Word模板)
│   │   └── 申請表模板.pdf                (PDF模板)
│   └── 生成文件/                         (系統生成的PDF)
│       ├── 申請表_2025年10月_20250912-022107.pdf
│       ├── 申請表_2025年10月_20250912-024441.pdf
│       └── ...
└── 系統記錄/                             (選用，方便管理)
    └── 申請記錄.gsheet                   (Google Sheets記錄)
```

#### 檔案配置詳細說明
- **街頭藝人證照**：
  - 路徑：`/街頭藝人登記/證照文件/街頭藝人證.jpg`
  - 檔案格式：JPG
  - 更新方式：手動替換檔案（當證照更新時）

- **常用表演影片**：
  - 路徑：`/街頭藝人登記/表演影片/表演影片.mp4`
  - 檔案格式：MP4/MOV等常見影片格式
  - 更新方式：手動替換檔案（當需要更新表演內容時）

- **新上傳影片**：
  - 路徑：`/街頭藝人登記/表演影片/上傳影片/表演影片_YYYY年MM月_MMDD_HHMM.mp4`
  - 命名規則：按申請月份和時間戳記自動命名
  - 存儲方式：系統自動上傳並歸檔

- **申請文件模板**：
  - 路徑：`/街頭藝人登記/申請文件/模板/申請表模板.docx`
  - 用途：系統自動下載並填寫申請資訊
  - 更新方式：手動替換模板（當表單格式變更時）

- **生成的申請文件**：
  - 路徑：`/街頭藝人登記/申請文件/生成文件/申請表_YYYY年MM月_YYYYMMDD-HHmmss.pdf`
  - 命名規則：按申請月份和時間戳記自動命名
  - 用途：提交到表演場地網站的最終文件

## 📊 資料結構設計

### Google Sheets結構
```
| 時間戳記 | 用戶ID | 申請月份 | 選擇日期 | 影片來源 | 影片連結 | 狀態 | 錯誤訊息 | PDF路徑 | 處理開始時間 | 處理完成時間 |
|----------|--------|----------|----------|----------|----------|------|----------|---------|-------------|-------------|
| 20250912-022107 | U123... | 2025/10 | 2025/10/4,2025/10/11,2025/10/18 | 常用影片 | drive.com/default | 完成 | | drive.com/pdf | 20250912-022107 | 20250912-022107 |
| 20250912-024441 | U987... | 2025/10 | 2025/10/5,2025/10/19 | 新上傳 | drive.com/new_video | 完成 | | drive.com/pdf | 20250912-024441 | 20250912-024441 |
| 20250912-031630 | U123... | 2025/10 | 2025/10/12,2025/10/19 | 常用影片 | drive.com/default | 失敗 | 網站連接超時 - 重試3次後仍失敗 | drive.com/pdf | 20250912-031630 | (空白-失敗) |
```

#### 資料欄位說明
- **時間戳記**：使用 YYYYMMDD-HHmmss 格式，作為唯一識別碼
- **用戶ID**：LINE系統自動分配的唯一識別碼
- **影片來源**：「常用影片」或「新上傳」，標記使用的影片類型
- **日期格式**：實際日期，以逗號分隔（例如：2025/10/4,2025/10/11,2025/10/18）
- **日期彈性**：支援1-3個日期，不限制必須選滿，可含週六和週日
- **處理開始時間**：系統開始執行自動化流程的時間點（從Google Cloud Run服務被觸發開始）
- **處理完成時間**：申請成功提交到表演場地網站並截圖存入Google Drive的時間點（成功時記錄，失敗時保持空白）
- **錯誤訊息格式**：記錄具體錯誤描述，例如「網站連接超時 - 重試3次後仍失敗」、「找不到檔案上傳欄位 - 可能網站改版」
- **處理時間相同**：處理開始時間 = 處理完成時間是正常現象，表示系統處理速度極快（<1秒）

### 狀態管理機制

#### 狀態定義與時間戳記對應
- **`待處理`**：資料已收集，等待處理
  - 處理開始時間：空白
  - 處理完成時間：空白

- **`處理中`**：自動化流程執行中
  - 處理開始時間：已記錄（系統開始處理的時間點）
  - 處理完成時間：空白（處理尚未結束）

- **`完成`**：申請成功提交
  - 處理開始時間：已記錄
  - 處理完成時間：已記錄（成功提交到表演場地網站並截圖存入Google Drive的時間點）

- **`失敗`**：處理失敗，需要人工介入
  - 處理開始時間：已記錄
  - 處理完成時間：空白（失敗時不記錄完成時間，保持空白）
  - 錯誤訊息：記錄具體失敗原因

#### 狀態判斷邏輯
透過「狀態」欄位可明確區分每筆申請的處理狀況：
- 有開始時間 + 無完成時間 + 狀態「處理中」= 正在處理
- 有開始時間 + 無完成時間 + 狀態「失敗」= 處理失敗
- 有開始時間 + 有完成時間 + 狀態「完成」= 處理成功

## 🔄 用戶操作流程

### 3.1 標準申請流程（極簡版）
**情境：使用者在8月5日說「申請」，系統自動判斷申請9月份**

| 步驟 | 用戶操作 | Bot回應 | 系統處理 |
|------|----------|---------|----------|
| 1 | 使用者：「申請」 | 「申請9月份」<br/>「日期：9/7、9/14、9/21（前3個週六）」<br/>「影片：使用常用影片」<br/>「確認請說『好』，要修改請說『改日期』或『改影片』」 | AI解析申請意圖，系統推算月份並計算預設日期 |
| 2a | 使用者：「好」 | 「開始處理申請，請稍候...」 | 使用預設值，觸發自動化流程 |
| 2b | 使用者：「改日期」 | 「9月可選日期：」<br/>「週六：9/7、9/14、9/21、9/28」<br/>「週日：9/1、9/8、9/15、9/22、9/29」<br/>「請告訴我要哪幾天」 | 進入日期修改流程 |
| 2c | 使用者：「改影片」 | 「請上傳新的影片」<br/>「直接在這裡傳送影片檔案即可」 | 進入影片上傳流程 |
| 3 | (處理完成) | 「申請已成功提交！」 | 完成所有處理流程 |

### 3.2 修改流程（分開處理）
**情境：使用者需要修改日期或影片**

| 步驟 | 用戶操作 | Bot回應 | 系統處理 |
|------|----------|---------|----------|
| 1 | 使用者：「申請」 | 「申請10月份」<br/>「日期：10/5、10/12、10/19（前3個週六）」<br/>「影片：使用常用影片」<br/>「確認請說『好』，要修改請說『改日期』或『改影片』」 | 系統推算月份並計算預設日期 |
| 2 | 使用者：「修改」 | 「要修改什麼？請說『改日期』或『改影片』」 | 等待用戶指定修改項目 |
| 3a | 使用者：「改日期」 | 「10月可選日期：」<br/>「週六：10/5、10/12、10/19、10/26」<br/>「週日：10/6、10/13、10/20、10/27」<br/>「請告訴我要哪幾天」 | 進入日期選擇模式 |
| 3b | 使用者：「改影片」 | 「請上傳新的影片」<br/>「直接在這裡傳送影片檔案即可」 | 進入影片上傳模式 |
| 4a | 使用者：「第一個週六和週日」 | 「確認日期：10/5(六)、10/6(日)」<br/>「影片：使用常用影片」<br/>「確認請說『好』」 | AI解析日期選擇 |
| 4b | 使用者：[上傳影片] | 「影片收到！」<br/>「日期：10/5、10/12、10/19」<br/>「影片：使用新上傳影片」<br/>「確認請說『好』」 | 系統處理影片上傳 |
| 5 | 使用者：「好」 | 「開始處理申請...」 | 執行自動化流程 |

### 3.3 AI語音錯誤處理範例
**展示AI如何處理各種語音輸入錯誤**

#### 範例A：語音錯誤自動修正
| 步驟 | 用戶操作 | Bot回應 | 系統處理 |
|------|----------|---------|----------|
| 1 | 使用者：「藥深頃」 | 「收到！要申請下個月的場地嗎？」 | AI解析：intent="apply", confidence=0.85，直接執行 |
| 2 | 使用者：「對」 | 「9月份申請（自動判斷）」<br/>「預設日期：9/7(六), 9/14(六), 9/21(六)」<br/>「要使用這些日期嗎？」 | AI確認申請意圖，進入申請流程 |

#### 範例B：自然語言日期選擇
| 步驟 | 用戶操作 | Bot回應 | 系統處理 |
|------|----------|---------|----------|
| 1 | 使用者：「前兩個週六」 | 「確認申請日期：」<br/>「10/5 (週六) 和 10/12 (週六)」<br/>「這樣正確嗎？」 | AI解析：selected_dates=[1,2], confidence=0.92 |
| 2 | 使用者：「對的」 | 「將使用常用影片進行申請...」 | AI確認選擇，繼續流程 |

#### 範例C：信心度不足需確認
| 步驟 | 用戶操作 | Bot回應 | 系統處理 |
|------|----------|---------|----------|
| 1 | 使用者：「我想要...呃...那個」 | 「不太確定您的意思」<br/>「是要申請場地嗎？」 | AI解析：intent="unclear", confidence=0.3 |
| 2 | 使用者：「對，申請」 | 「收到！要申請下個月的場地...」 | AI重新解析，進入申請流程 |

### 3.4 時間窗口控制流程
**情境：使用者在8月20日說「申請」，不在申請窗口期內**

| 步驟 | 用戶操作 | Bot回應 | 系統處理 |
|------|----------|---------|----------|
| 1 | 使用者：「申請」 | 「目前不在申請期間」<br/>「10月份申請將在9月1-15日開放」<br/>「謝謝！」 | AI解析申請意圖，傳統系統檢查當前日期並判斷不在申請窗口期 |

### 3.5 系統錯誤處理流程
**情境：自動化處理過程中發生錯誤**

| 步驟 | 系統狀態 | 系統處理 | LINE通知 |
|------|----------|----------|----------|
| 0 | 處理中 | 記錄處理開始時間，開始自動化流程 | - |
| 1 | 處理中 | 網站操作失敗（例如：連接超時） | - |
| 2 | 處理中 | 等待30秒後自動重試第1次 | - |
| 3 | 處理中 | 仍失敗，等待30秒後自動重試第2次 | - |
| 4 | 處理中 | 仍失敗，等待30秒後自動重試第3次 | - |
| 5 | 失敗 | 更新Google Sheets：<br/>- 狀態：「失敗」<br/>- 錯誤訊息：「網站連接超時 - 重試3次後仍失敗」<br/>- 處理完成時間：保持空白 | 「申請處理失敗，需要人工協助<br/>申請月份：2024年10月<br/>錯誤原因：網站連接超時<br/>PDF檔案：[Google Drive連結]<br/>請家人到表演場地網站手動提交」 |
| 6 | 失敗 | 系統處理結束，等待人工處理 | - |


## 🤖 AI語音處理方案

### OpenAI API整合架構

#### 技術選型
- **模型選擇**：GPT-4o-mini（成本低，性能足夠語音處理需求）
- **API配置**：溫度0.1，最大Token 300，超時10秒，重試2次
- **成本控制**：每月調用上限3000次，預估成本<台幣30元

#### 語音處理流程
```
使用者語音 → LINE文字轉換 → Google Apps Script → OpenAI API語意解析 → 處理結果 → 回應用戶
```

#### 系統職責劃分
**明確區分AI語意處理與傳統業務邏輯**

✅ **AI系統處理**：
- **語音錯誤修正**：處理語音轉文字的錯誤（「藥深頃」→「申請」）
- **意圖識別**：理解用戶意圖（申請、確認、修改）
- 日期選擇解析（專注具體日期號碼，如「十月十一」→「11號」）
- 無關輸入識別和引導
- 提供信心度評分

✅ **傳統系統處理**：
- **時間窗口檢查**：判斷是否在申請期間（1-15日規則）
- **月份推算**：計算申請月份（當前月+1或+2）
- **日期計算**：計算週六週日具體日期
- Google Drive檔案操作
- Word模板填寫和PDF生成
- 網站自動化（表演場地網站操作）
- Google Sheets狀態記錄
- 檔案上傳和下載
- 申請流程控制

### 智能語意解析機制

#### 信心度管理
- **高信心度（≥0.9）**：直接執行，無需確認（提高準確性要求）
- **中信心度（0.7-0.9）**：請用戶確認理解是否正確（提高準確性要求）
- **低信心度（<0.7）**：請用戶重新表達

#### 確認策略
- **一般指令**：基於信心度決定是否確認
- **重要操作**（開始申請、提交）：一律確認一次，確保準確性

#### 語音錯誤處理範例
```
用戶輸入：「藥深頃」
AI解析：intent="apply", confidence=0.85
系統回應：「收到！要申請下個月的場地嗎？」

用戶輸入：「一五」（在日期選擇情境）
AI解析：selected_indices=[1,5], confidence=0.75  
系統回應：「確認選擇第1個和第5個日期嗎？」
```

### 邊界情況處理

#### 無關輸入處理
- **友善引導**：「我沒聽懂您的意思，您是要申請場地嗎？請說『申請』開始」
- **提供範例**：當多次無法理解時，提供可接受的指令範例

#### 超時處理機制
- **計算起點**：系統發送問題後開始計時
- **超時時間**：5分鐘（考慮視障用戶需要更多思考時間）
- **處理方式**：
  - 第一次超時：「還在嗎？需要繼續申請請告訴我」
  - 第二次超時：「對話已結束，下次想申請請重新說『申請』」

#### 多用戶使用
- **彈性權限**：群組中任何成員都可觸發申請（支援主要使用者、家人協助或測試）
- **操作記錄**：在Google Sheets中記錄操作者的LINE用戶ID和名稱，便於追蹤和管理

### 容錯降級機制

#### API失敗處理
- **自動重試**：API調用失敗時自動重試2次
- **降級策略**：API完全失敗時回退到基本關鍵字匹配
- **用戶通知**：「系統暫時繁忙，請用簡單詞語如『申請』『確認』」

#### 關鍵字備案
```javascript
備案關鍵字對照：
{
  "申請": ["申請", "身請", "伸請", "要申請"],
  "確認": ["確認", "確人", "對", "隊", "好", "可以"],
  "修改": ["修改", "修該", "不對", "重選", "不要"]
}
```

## 📋 各階段重點技術棧

| Phase | 主要技術 | 開發重點 | 核心產出 |
|-------|----------|----------|----------|
| 1 | JavaScript (GAS) + LINE API | 基礎對話功能 | 可回應的LINE Bot |
| 2 | JavaScript + OpenAI API | AI語意理解 | 智能指令識別 |
| 3 | JavaScript + Google Drive API | 日期邏輯計算 + 影片處理 | 時間窗口管理 + 檔案上傳 |
| 4 | JavaScript + Google Sheets API | 資料存儲 | 完整資料記錄 |
| 5 | Python + Cloud Run + 文件處理 | 文件生成系統 | Word→PDF自動處理 + 自動化流程 |
| 6 | Python + Playwright + 整合測試 | 網站自動化 | 完整可用系統 |


## 📋 開發參考

詳細的開發階段規劃、API設置指南、問題排解和部署說明請參考 `development-guide.md`。


## 📈 成功指標

### 功能指標
- 申請成功率 > 95%
- 平均處理時間 < 10分鐘
- 錯誤自動修復率 > 80%
- AI API可用率 > 99%（含降級機制）

### 用戶體驗指標
- 視障使用者獨立完成申請 > 90%
- AI語意理解準確率 > 95%
- 語音錯誤自動修正率 > 90%
- 用戶滿意度評分 > 4.5/5

### AI性能指標
- AI回應時間 < 3秒
- 信心度評分準確性 > 90%
- 降級機制觸發率 < 5%

## 🔒 安全和隱私

### 資料保護
- Google API使用Service Account認證
- 敏感資訊加密存儲
- 定期清理過期資料

### 存取控制
- LINE群組成員限制
- Google Drive檔案權限管控
- Cloud Run服務認證

## 🚀 未來優化項目

### 功能擴展
- **API使用量追蹤**：監控OpenAI API使用量和成本分析
- **查詢狀態功能**：讓用戶可以查詢申請進度和歷史記錄
- **申請管理功能**：支援取消申請、重新申請等操作
- **申請取消功能**：允許用戶在處理中階段取消申請
- **多語言支援**：支援其他語言介面
- **申請提醒**：自動提醒申請時間窗口開放
- **權限分級**：不同用戶具有不同操作權限
- **智能預設影片**：預設影片調整為當時Google Drive資料夾最新一次的影片檔案

### 用戶體驗優化
- **語音回覆**：Bot可以語音回覆，更適合視障用戶
- **快速重複申請**：記住用戶偏好的日期選擇
- **申請統計**：提供申請成功率和歷史統計

## 📞 支援和維護

### 監控機制
- Cloud Run服務監控
- Google Sheets狀態監控
- LINE Bot回應時間監控
- **GAS 服務穩定性監控**：每日自動喚醒觸發器，防止服務因長時間未使用而失效

### 維護計劃
- **每日自動維護**：GAS 自動喚醒觸發器保持服務活躍
- 每月檢查申請網站變化
- 季度性能優化
- 年度功能更新評估

### GAS 服務穩定性保障
**背景**：Google Apps Script 免費版服務會因長時間未使用而失效，導致 LINE Bot 無回應

**解決方案**：
- **每日自動喚醒機制**：設定 GAS 時間觸發器，每天自動執行簡單函數
- **預期效果**：將部署失效頻率從幾天一次降低到幾週或幾個月一次
- **維護成本**：極低（每天一條日誌記錄，消耗可忽略的配額）

---

**文件版本**: v1.0  
**建立日期**: 2025年8月30日  
**最後更新**: 2025年8月30日  

