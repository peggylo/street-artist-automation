# reCAPTCHA 圖片驗證處理方案

## 📋 問題描述

### 當前狀況
- **階段**：Phase 6 階段 2B（測試模式，停在提交前）
- **問題**：表演場地網站的 reCAPTCHA 驗證會觸發圖片選擇驗證
- **關鍵發現**：**透過 Cloud Run 執行時，目前 100% 觸發圖片驗證**
  - Cloud Run 環境的自動化特徵被 reCAPTCHA 識別
  - 每次執行都會要求選擇圖片
  - **當前無法處理圖片選擇驗證**
  - 本地測試環境多數不觸發（僅開發過渡階段，非重點）

### 實際觸發案例
**Cloud Run 環境**測試過程中遇到的圖片驗證類型：

#### 案例 1：選擇自行車（bicycles）
![圖片選擇驗證1](申請截圖/圖片選擇驗證1.png)
- **要求**：選擇所有包含自行車的圖片
- **格式**：3×3 網格圖片
- **語言**：英文界面

#### 案例 2：選擇公交車（bus）
![圖片選擇驗證2](申請截圖/圖片選擇驗證2.png)
- **要求**：選擇所有包含公交車的圖片
- **格式**：3×3 網格圖片
- **語言**：英文界面

**觀察**：
- 驗證物體類型動態變化（自行車、公交車等交通工具）
- 每次觸發都是不同的挑戰題目
- 介面統一（3×3 網格 + "VERIFY" 按鈕）

### 技術背景
- **reCAPTCHA 類型**：包含勾選框和圖片挑戰
- **觸發模式**：**Cloud Run 環境 100% 觸發**
- **觸發原因分析**：
  - Cloud Run 無頭瀏覽器特徵明顯
  - GCP 數據中心 IP 地址被識別為非住宅 IP
  - 自動化工具指紋（Playwright）被檢測
  - 缺乏真實用戶行為模式（滑鼠移動、瀏覽歷史等）
  - Google 的風險評估算法判定為高風險

### 當前實作狀態
- ✅ 可以點擊 reCAPTCHA 勾選框
- ❌ **無法處理圖片選擇驗證**（Cloud Run 100% 觸發）
- ❌ **無法偵測是否觸發了圖片驗證**
- ❌ **程式會在圖片驗證處卡住**

### 影響範圍
- **主流程完全中斷**：Cloud Run 執行時 100% 無法完成提交
- **用戶體驗**：系統無回應，必須人工介入
- **測試優勢**：穩定觸發，容易重現和測試解決方案

---

## 🎯 解決方案方向

**待討論解決方向**

需要考慮的關鍵點：
1. 如何偵測圖片驗證是否被觸發（目前 Cloud Run 100% 觸發）
2. 如何處理圖片選擇驗證（識別題目、選擇圖片、提交驗證）
3. 圖片驗證的降級策略（自動化 vs. 人工處理）
4. 是否需要規避觸發（改善瀏覽器指紋、使用代理等）
5. 平衡實作複雜度、成本與系統可靠性

**測試環境優勢**：
- ✅ Cloud Run 100% 穩定觸發，方便測試
- ✅ 可以快速驗證解決方案是否有效
- ✅ 不需要等待隨機觸發

---

## 🔗 相關資源

### 專案檔案
- `code/cloud-run/website_automation_cloud.py` - 當前 reCAPTCHA 處理邏輯（第 358-394 行）
- `code/cloud-run/main.py` - 錯誤處理和降級機制
- `code/gas/Code.js` - LINE 通知邏輯
- `申請截圖/圖片選擇驗證1.png` - 自行車驗證案例
- `申請截圖/圖片選擇驗證2.png` - 公交車驗證案例

---

**建立時間**：2025年10月25日  
**狀態**：問題分析階段，解決方案待討論  
**負責階段**：Phase 6 階段 2C

