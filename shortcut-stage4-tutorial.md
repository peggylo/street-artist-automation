# 階段 4：參數化改造

## 🎯 測試目標

讓 Shortcut 能接收來自 LINE 的動態 PDF URL，不再使用硬編碼

**預估時間**：15 分鐘

---

## 📝 重點說明

這個階段要做：
1. 修改「松菸申請」Shortcut，加入「取得捷徑輸入」
2. 將 PDF URL 改為動態接收（從 LINE 傳入）
3. 證照 URL 保持固定（不變）
4. 學習如何用 LINE 測試

---

## 📱 修改現有的 Shortcut

### 步驟 1：開啟「松菸申請」

1. 在 Shortcut App 中
2. 找到「松菸申請」
3. 點擊進入編輯模式

---

### 步驟 2：新增「取得捷徑輸入」動作

**位置**：放在最前面（第一個動作）

1. 滑到最上方
2. 點擊搜尋框
3. 搜尋：`取得捷徑輸入`
4. 點選「取得捷徑輸入」動作
5. **長按**這個動作，拖曳到最上方（第一個位置）

**設定**：
- 類型：保持預設（文字）
- 不需要修改其他設定

---

### 步驟 3：將輸入存成變數

1. 點擊剛加入的「取得捷徑輸入」動作
2. 長按動作結果（會出現「捷徑輸入」泡泡）
3. 點選「設定變數」
4. 變數名稱改為：`PDF網址`
5. 點擊「完成」

---

### 步驟 4：修改 PDF 下載動作（動作 2）

找到「下載檔案」動作（原本是第一組的第一個動作，現在變成第二個）

1. 點擊 URL 欄位，**清空原有的 URL**
2. 點擊變數按鈕（輸入框右邊的藥丸圖示）
3. 選擇「PDF網址」變數

**確認**：URL 欄位應該顯示「PDF網址」（藍色泡泡）

---

### 步驟 5：確認證照下載保持不變

找到「下載檔案」動作（第二組，下載證照的那個）

**確認**：
- URL 應該仍然是固定的 Google Drive 證照 URL
- **不要修改這個動作**
- 證照 URL 保持寫死在 Shortcut 中

---

## 📋 檢查完整流程

現在你的 Shortcut 應該有 **14 個動作**：

**第 0 組：接收輸入**（動作 1）
1. 取得捷徑輸入 → 存到變數「PDF網址」

**第一組：下載 PDF**（動作 2-6）
2. 下載檔案 → 使用變數「PDF網址」（動態）
3. 設定名稱
4. 儲存檔案
5. 等待
6. 朗讀文字

**第二組：下載證照**（動作 7-11）
7. 下載檔案 → 使用固定 URL（不變）
8. 設定名稱
9. 儲存檔案
10. 等待
11. 朗讀文字

**第三組：開啟網站**（動作 12-14）
12. 開啟 URL
13. 等待
14. 朗讀文字

---

## ✅ 完成設定

1. 確認動作 1 是「取得捷徑輸入」
2. 確認動作 2 的 URL 是變數「PDF網址」
3. 確認證照下載 URL 沒有改變
4. 點擊右上角「完成」

---

## 🚀 測試方式 1：直接執行（應該會失敗）

### 執行步驟

1. 在「我的捷徑」頁面找到「松菸申請」
2. 直接點擊執行

### 預期結果

**會出現輸入提示**：
- 系統會要求你輸入 PDF URL
- 你可以手動貼上測試 PDF URL
- 或者直接取消，改用方式 2 測試

**這是正常的！** 因為我們還沒有透過 LINE 傳入 URL

---

## 🚀 測試方式 2：透過 LINE 測試（推薦）

### 步驟 1：準備測試 URL

**格式**：
```
shortcuts://run-shortcut?name=松菸申請&input=text&text=YOUR_PDF_URL
```

**實際範例**（請替換成你的測試 PDF URL）：
```
shortcuts://run-shortcut?name=松菸申請&input=text&text=https://drive.google.com/uc?export=download&id=YOUR_FILE_ID
```

**重要**：
- `YOUR_FILE_ID` 是你的測試 PDF 檔案 ID
- URL 不需要編碼，iOS 會自動處理

---

### 步驟 2：在 LINE 傳送測試訊息

1. 開啟 LINE App
2. 找一個測試聊天室：
   - 可以傳給「Saved Messages」（傳給自己）
   - 或建立一個「測試群組」（只有你自己）
   - 或傳給「LINE Keep」

3. **複製完整的 Shortcut URL**
4. **貼上並發送**

---

### 步驟 3：點擊測試訊息

1. 點擊剛剛發送的 Shortcut URL
2. iOS 會詢問：「在"捷徑"中打開？」
3. 點選「打開」
4. Shortcut 會自動執行

---

### 步驟 4：觀察執行結果

**預期行為**：
1. ✅ 開始下載 PDF（動態 URL）
2. ✅ 語音：「PDF 下載完成」
3. ✅ 開始下載證照（固定 URL）
4. ✅ 語音：「街頭藝人證下載完成」
5. ✅ 語音：「兩個檔案都下載好了」
6. ✅ Safari 自動開啟松菸網站
7. ✅ 語音：「已開啟網站，請點擊松菸申請書籤」

---

## ✅ 驗收標準

### 必須通過的檢查

- [ ] **Shortcut 能接收 LINE 傳入的 URL**
- [ ] **動態 PDF 成功下載**（檔案名稱正確）
- [ ] **固定證照成功下載**（檔案名稱正確）
- [ ] **檔案順序正確**（PDF 先、證照後）
- [ ] **Safari 自動開啟松菸網站**
- [ ] **所有語音提示正常播放**

### 如何驗證

**方法 1：檢查下載項目**
1. 開啟「檔案」App
2. 進入「iCloud Drive」→ 「Downloads」資料夾
3. 確認兩個檔案都存在

**方法 2：檢查 Shortcut 執行記錄**
1. 在 Shortcut App 中
2. 點擊「松菸申請」右上角「...」
3. 查看執行歷史

---

## ❓ 常見問題

### Q1：點擊 LINE 訊息後沒有反應

**可能原因**：
- URL 格式錯誤
- Shortcut 名稱不符（必須是「松菸申請」）
- iOS 沒有詢問是否打開

**解決方式**：
1. 檢查 Shortcut 名稱是否完全一致（包含空格）
2. 確認 URL 格式正確
3. 重新複製貼上 URL

---

### Q2：Shortcut 執行但沒有下載檔案

**可能原因**：
- PDF URL 無效或無法存取
- 網路連線問題
- iCloud Drive 空間不足

**解決方式**：
1. 確認測試 PDF URL 是公開的（在瀏覽器測試能否下載）
2. 檢查網路連線
3. 確認 iCloud Drive 有足夠空間

---

### Q3：只下載了 PDF，沒有下載證照

**可能原因**：
- 不小心修改了證照下載動作
- 證照 URL 失效

**解決方式**：
1. 檢查動作 7（證照下載）的 URL
2. 確認證照 URL 仍然是固定的 Google Drive URL
3. 在瀏覽器測試證照 URL 能否下載

---

### Q4：收到錯誤訊息「無法下載檔案」

**可能原因**：
- Google Drive URL 權限不足
- 檔案未設為公開

**解決方式**：
1. 確認測試 PDF 檔案設為「知道連結的任何人都能檢視」
2. 使用正確的下載 URL 格式：
   ```
   https://drive.google.com/uc?export=download&id=FILE_ID
   ```

---

### Q5：下載後的 PDF 檔名出現亂碼

**問題**：
- 原始檔名：`申請表_2025年10月_1011_0724.pdf`
- 下載後變成：`ç³è«è¡¨_2025å¹´10æ_1011_0724.pdf`

**原因**：
Google Drive 回傳的中文檔名使用 UTF-8 編碼，但 iOS Shortcuts 誤判為 Latin-1，導致亂碼。

**解決方式**：
在 Shortcut 中手動設定檔名，不依賴 Google Drive 的檔名：
1. 在下載動作前加入「文字」動作
2. 輸入：`申請表_` 並插入「當前日期」變數
3. 設定日期格式：`yyyy年MM月_MMdd_HHmm`
4. 加上 `.pdf` 結尾
5. 存成變數「檔案名稱」
6. 在「儲存檔案」動作中使用此變數

**注意**：檔名時間會是 Shortcut 執行時間，而非 PDF 產生時間

---

## 💡 進階說明

### Shortcut URL 參數說明

**基本格式**：
```
shortcuts://run-shortcut?name=捷徑名稱&input=輸入類型&text=輸入內容
```

**參數說明**：
- `name=松菸申請`：Shortcut 名稱（必須 URL 編碼，但中文可以直接用）
- `input=text`：輸入類型（文字）
- `text=...`：實際傳入的內容（PDF URL）

---

### 為什麼證照 URL 不動態傳入？

**原因**：
1. 證照檔案不會變動
2. 簡化 LINE 訊息（只傳一個 URL）
3. 減少傳輸錯誤機率

**好處**：
- LINE 訊息更簡潔
- 不會因為傳入錯誤證照 URL 而失敗
- 維護更容易

---

## 🎉 完成階段 4！

恭喜！你已經完成：
- ✅ Shortcut 參數化改造
- ✅ 動態接收 PDF URL
- ✅ 證照 URL 保持固定
- ✅ 學會透過 LINE 觸發 Shortcut

---

## 📋 下一步：階段 5（GAS 整合）

完成這個測試後，下一步：
1. 在 GAS 中實作 `sendShortcutLinkToLine()` 函數
2. 設定 PDF 檔案公開權限
3. 透過 LINE 發送 Shortcut 按鈕（Quick Reply）
4. 端到端測試：LINE 申請 → 自動發送 Shortcut 連結

詳見：`shortcut-stage5-tutorial.md`（待撰寫）

---

## 🔧 測試工具

### LINE 測試訊息範本

如果你想建立一個可重複使用的測試訊息，可以：

1. 在 LINE 的「Keep」中儲存測試 URL
2. 每次需要測試時，從 Keep 複製貼上
3. 更換不同的 PDF URL 測試不同檔案

### 測試清單

建議測試以下情境：

- [ ] 測試有效的 PDF URL
- [ ] 測試無效的 PDF URL（觀察錯誤處理）
- [ ] 測試超大檔案 URL（觀察下載時間）
- [ ] 連續點擊兩次（觀察是否會衝突）
- [ ] 在不同網路環境測試（Wi-Fi vs 4G）

---

**建立日期**：2025-11-15  
**最後更新**：2025-11-21  
**狀態**：階段 4 完成 ✅

**重要發現**：
- ⚠️ Google Drive 中文檔名會產生 UTF-8 編碼亂碼
- ✅ 解決方案：在 Shortcut 中手動設定檔名（使用當前日期時間格式）
- 📝 檔名格式：`申請表_yyyy年MM月_MMdd_HHmm.pdf`

**重要提醒**：
- 確保測試 PDF URL 已設為公開
- LINE 訊息中的 URL 可以直接點擊
- 成功後再進入階段 5（GAS 整合）

